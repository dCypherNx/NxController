name: Release on version change

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect version change
        id: version
        run: |
          CURRENT=$(python - <<'PY'
import json
from pathlib import Path
manifest = json.loads(Path("custom_components/nx_controller/manifest.json").read_text())
print(manifest.get("version", ""))
PY
)
          PREVIOUS=""
          if git rev-parse HEAD^ >/dev/null 2>&1 && git show HEAD^:custom_components/nx_controller/manifest.json > /tmp/prev.json 2>/dev/null; then
            PREVIOUS=$(python - <<'PY'
import json
from pathlib import Path
manifest = json.loads(Path("/tmp/prev.json").read_text())
print(manifest.get("version", ""))
PY
)
          fi
          echo "current=${CURRENT}" >> "$GITHUB_OUTPUT"
          echo "previous=${PREVIOUS}" >> "$GITHUB_OUTPUT"
          if [ "$CURRENT" != "$PREVIOUS" ]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Prepare release archive
        if: steps.version.outputs.changed == 'true'
        run: |
          ARCHIVE="nx-controller-${{ steps.version.outputs.current }}.zip"
          zip -r "$ARCHIVE" custom_components README.md hacs.json
          echo "archive=$ARCHIVE" >> "$GITHUB_OUTPUT"
        id: package

      - name: Create release
        if: steps.version.outputs.changed == 'true'
        uses: ncipollo/release-action@v1
        with:
          tag: v${{ steps.version.outputs.current }}
          name: v${{ steps.version.outputs.current }}
          generateReleaseNotes: true
          artifacts: ${{ steps.package.outputs.archive }}

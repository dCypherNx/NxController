name: Tag latest main

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  tag:
    runs-on: ubuntu-latest
    env:
      RELEASE_WORKFLOW: Release
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Read integration version
        id: manifest
        run: echo "version=$(jq -r .version custom_components/nx_controller/manifest.json)" >> "$GITHUB_OUTPUT"

      - name: Prepare tag name
        id: tag
        run: echo "name=v${{ steps.manifest.outputs.version }}" >> "$GITHUB_OUTPUT"

      - name: Check if tag exists
        id: exists
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const tag = '${{ steps.tag.outputs.name }}';
            try {
              await github.rest.git.getRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `tags/${tag}`,
              });
              core.setOutput('present', 'true');
            } catch (error) {
              if (error.status === 404) {
                core.setOutput('present', 'false');
              } else {
                throw error;
              }
            }

      - name: Create tag on latest main
        if: steps.exists.outputs.present == 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const tag = '${{ steps.tag.outputs.name }}';
            await github.rest.git.createRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: `refs/tags/${tag}`,
              sha: context.sha,
            });

      - name: Trigger release workflow
        if: steps.exists.outputs.present == 'false'
        uses: peter-evans/workflow-dispatch@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          workflow: ${{ env.RELEASE_WORKFLOW }}
          ref: ${{ github.ref }}
          inputs:
            tag: ${{ steps.tag.outputs.name }}
